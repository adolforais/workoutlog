<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adolfo's Performance Analysis</title>
  <!-- Copied styling directly from index.html for consistency -->
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 15px;
      background-color: white; /* fallback */
      background-image: url('background.jpg');
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center center;
    }

    #mainContent {
      background-color: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 18px;
      color: black;
      max-width: 700px;
      margin: auto;
      box-shadow: 0 0 12px 2px #e3bc60;
    }

    h1 {
      color: #4a7d23;
      margin-bottom: 18px;
    }

    a {
      color: #4a7d23;
    }

    .analysis-card {
      border: 1px solid #ccc;
      border-left: 5px solid #4a7d23;
      border-radius: 6px;
      margin-bottom: 15px;
      padding: 12px;
      background-color: #fdfdfd;
    }
    
    .analysis-card h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #333;
    }

    .analysis-card p {
      margin: 5px 0;
      line-height: 1.4;
    }
    
    .analysis-card strong {
        color: #3b2a87;
    }

    .recommendation {
      font-weight: bold;
      font-style: italic;
      display: block;
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
    }

    .rec-reduce {
      color: #d0021b;
      background-color: #fdeaea;
    }

    .rec-increase {
      color: #a06c00;
      background-color: #fff8e1;
    }

    .rec-maintain {
      color: #3b2a87;
      background-color: #f0f3ff;
    }
    
    .rec-deload {
      color: #005a9c;
      background-color: #eaf6ff;
    }
  </style>
  <!-- The program data is required for the analysis -->
  <script src="workout_program.js"></script>
</head>
<body>
  <div id="mainContent">
    <h1>Full Performance Analysis</h1>
    <p><a href="index.html">‚Üê Back to Workout Logger</a></p>
    <hr />
    <div id="analysisReport">
      <!-- The generated report will be injected here by the script -->
    </div>
  </div>

  <script>
    // This is the JavaScript version of the Python analysis script
    document.addEventListener('DOMContentLoaded', function () {
      
      const rirTargets = ["2-3", "2", "1", "3-4"]; // RIR targets from the guide

      function getAnalysisForExerciseHTML(exerciseName, allLogs) {
        // Find the exercise definition in the program object
        const exDetails = (Object.values(program).flat()).find(e => e.name === exerciseName);
        if (!exDetails) return ''; // Skip if exercise not in program

        // Find the most recent log for this specific exercise
        let lastSession = null;
        for (let i = allLogs.length - 1; i >= 0; i--) {
            const foundEx = allLogs[i].log.find(l => l.name === exerciseName);
            if (foundEx) {
                lastSession = {
                    date: allLogs[i].date,
                    week: parseInt(allLogs[i].week),
                    weight: parseFloat(foundEx.weight),
                    reps: foundEx.reps.map(r => parseInt(r))
                };
                break;
            }
        }
        
        // This should not happen if we are iterating through logged exercises, but good practice
        if (!lastSession) return '';

        const weekIdx = lastSession.week - 1;
        const targetRepsStr = exDetails.reps[weekIdx];
        const targetSets = exDetails.sets[weekIdx];
        
        let recommendationHTML = '';

        const nextWeek = lastSession.week >= 4 ? 1 : lastSession.week + 1;

        if (nextWeek === 4 && lastSession.week === 3) {
            // Recommendation for upcoming deload week
            recommendationHTML = `<span class="recommendation rec-deload">ACTION: DELOAD WEEK. Use ${lastSession.weight} kg, reduce effort to RIR 3-4, and focus on perfect form.</span>`;
        } else {
            // Standard progression logic
            const repRangeParts = targetRepsStr.split('-');
            const minOfRepRange = parseInt(repRangeParts[0]);
            const topOfRepRange = parseInt(repRangeParts.pop());

            const failedToMeetMinimum = lastSession.reps.some(r => r < minOfRepRange);
            const achievedTopReps = lastSession.reps.length > 0 && lastSession.reps.every(r => r >= topOfRepRange);

            if (failedToMeetMinimum) {
                const newWeight = (lastSession.weight * 0.9).toFixed(1);
                recommendationHTML = `<span class="recommendation rec-reduce">ACTION: Reduce weight. You fell below the target rep range. Try ~${newWeight} kg next time.</span>`;
            } else if (achievedTopReps) {
                const newWeight = lastSession.weight + 2.5;
                recommendationHTML = `<span class="recommendation rec-increase">ACTION: Increase weight! You hit the top of the rep range. Try ~${newWeight} kg.</span>`;
            } else {
                recommendationHTML = `<span class="recommendation rec-maintain">ACTION: Keep weight the same. Your goal is to beat ${lastSession.reps.join(', ')} reps.</span>`;
            }
        }
        
        // Build the complete HTML card for this exercise
        return `
          <div class="analysis-card">
            <h3>${exerciseName}</h3>
            <p><strong>Last Session (Week ${lastSession.week}):</strong> ${lastSession.weight} kg for <strong>${lastSession.reps.join(', ')}</strong> reps.</p>
            <p><em>Program Target Was: ${targetSets} sets of ${targetRepsStr} reps @ RIR ${rirTargets[weekIdx]}</em></p>
            ${recommendationHTML}
          </div>
        `;
      }

      function generateFullReport() {
        const reportDiv = document.getElementById('analysisReport');
        const allLogs = JSON.parse(localStorage.getItem('hypertrophyLogs') || '[]');

        if (allLogs.length === 0) {
          reportDiv.innerHTML = '<p><i>No logs found. Go to the logger and save a session first!</i></p>';
          return;
        }

        const uniqueExercises = new Set();
        allLogs.forEach(session => {
          session.log.forEach(exercise => uniqueExercises.add(exercise.name));
        });
        
        const sortedExercises = Array.from(uniqueExercises).sort();

        let fullReportHTML = '';
        sortedExercises.forEach(exName => {
          fullReportHTML += getAnalysisForExerciseHTML(exName, allLogs);
        });

        reportDiv.innerHTML = fullReportHTML;
      }
      
      // Run the report generation when the page loads
      generateFullReport();
    });
  </script>
</body>
</html>